#!/bin/bash
set -e

BOT_DIR="/opt/discord-bot"
BACKUP_DIR="/root/discord-bot-backup"

echo "=== Vissstick Discord Bot Deployment Script ==="
echo ""

echo ">>> Stap 1: Backup maken van belangrijke bestanden"
mkdir -p "$BACKUP_DIR"

# Backup database (BELANGRIJK!)
if [ -f "$BOT_DIR/bot.db" ]; then
    TIMESTAMP=$(date +%Y%m%d-%H%M%S)
    cp "$BOT_DIR/bot.db" "$BACKUP_DIR/bot.db.backup-$TIMESTAMP"
    echo "✓ Database backup: bot.db.backup-$TIMESTAMP"
fi

# Backup config
if [ -f "$BOT_DIR/config.json" ]; then
    cp "$BOT_DIR/config.json" "$BACKUP_DIR/config.json"
    echo "✓ Config backup: config.json"
fi

cd /opt

echo ""
echo ">>> Stap 2: Verwijder oude bot directory"
rm -rf "$BOT_DIR"
echo "✓ Oude code verwijderd"

echo ""
echo ">>> Stap 3: Clone nieuwste code van GitHub"
git clone https://github.com/KimpiegamesYT1/Vissstick.git "$BOT_DIR"
echo "✓ Code gedownload"

echo ""
echo ">>> Stap 4: Herstel configuratie en database"

if [ -f "$BACKUP_DIR/config.json" ]; then
    cp "$BACKUP_DIR/config.json" "$BOT_DIR/config.json"
    echo "✓ config.json hersteld"
else
    echo "⚠️  Geen config.json backup gevonden! Maak deze aan in $BOT_DIR"
fi

if [ -f "$BACKUP_DIR/bot.db" ]; then
    # Gebruik de meest recente backup
    LATEST_DB=$(ls -t "$BACKUP_DIR"/bot.db.backup-* 2>/dev/null | head -1)
    if [ -n "$LATEST_DB" ]; then
        cp "$LATEST_DB" "$BOT_DIR/bot.db"
        echo "✓ Database hersteld: $(basename $LATEST_DB)"
    fi
else
    echo "ℹ️  Geen database backup gevonden - nieuwe database wordt aangemaakt"
fi

echo ""
echo ">>> Stap 5: Installeer Node.js dependencies"
cd "$BOT_DIR"
npm install --production
echo "✓ Dependencies geïnstalleerd"

echo ""
echo ">>> Stap 6: Controleer database"
if [ -f "$BOT_DIR/bot.db" ]; then
    echo "✓ Database aanwezig"
else
    echo "ℹ️  Nieuwe database wordt aangemaakt bij eerste start"
fi

echo ""
echo "=== Bot is klaar om te starten ==="
echo ""
echo "De bot draait nu in deze terminal."
echo "Gebruik CTRL+C om te stoppen."
echo ""

node bot.js
